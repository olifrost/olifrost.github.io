---
// BioBuilder.astro - Interactive bio building component
---

<div class="max-w-none mx-auto" id="bio-builder">
    <!-- Photo section - now at top -->
    <div class="mb-8">
        <!-- Photo carousel -->
        <div class="relative mb-6">
            <div id="photo-carousel" class="overflow-hidden rounded-lg shadow-md aspect-[16/9] bg-gray-100">
                <div class="flex transition-transform duration-300 ease-in-out h-full" id="carousel-track">
                    <img src="/img/olifrost.jpg" alt="Oli Frost - Headshot 1" class="w-full flex-shrink-0 h-full object-cover">
                    <img src="/img/olifrost-full.jpg" alt="Oli Frost - Full body" class="w-full flex-shrink-0 h-full object-cover">
                    <img src="/img/olifrost-carrot.jpg" alt="Oli Frost - With carrot" class="w-full flex-shrink-0 h-full object-cover">
                </div>
            </div>
            
            <!-- Carousel controls -->
            <div class="flex justify-center mt-4 space-x-2">
                <button class="carousel-dot w-3 h-3 rounded-full bg-blue-600" data-slide="0"></button>
                <button class="carousel-dot w-3 h-3 rounded-full bg-gray-300" data-slide="1"></button>
                <button class="carousel-dot w-3 h-3 rounded-full bg-gray-300" data-slide="2"></button>
            </div>
        </div>
    </div>

    <!-- Bio output section -->
    <div class="mb-8">
        <div class="bg-gray-50 p-6 rounded-lg mb-6">
            <h2 class="text-xl font-semibold mb-4">Your Bio <span class="text-sm font-normal text-gray-600">(click blue text to edit)</span></h2>
            
            <div id="bio-output" class="prose prose-lg max-w-none leading-relaxed space-y-4 text-gray-900">
                <p>
                    Oli Frost <span class="bio-variable" data-type="intro">makes songs, films and websites about the climate crisis</span>. 
                    He <span class="bio-variable" data-type="achievement1">got Greta Thunberg dancing the macarena</span>, <span class="bio-variable" data-type="achievement2">created a fossil fuel funfair</span>, and <span class="bio-variable" data-type="achievement3">made a video game about asset management</span>.
                </p>
                
                <p>
                    His work has been featured everywhere from <span class="bio-variable" data-type="outlet1">UK Parliament</span> to <span class="bio-variable" data-type="outlet2">Britain's Got Talent</span>, <span class="bio-variable" data-type="outlet3">BBC</span> to <span class="bio-variable" data-type="outlet4">Fox News</span>, in <span class="bio-variable" data-type="outlet5">music festivals</span>, <span class="bio-variable" data-type="outlet6">art shows</span>, and <span class="bio-variable" data-type="outlet7">on bins</span>.
                </p>
                
                <p>
                    <span class="bio-variable" data-type="stats1">It's given him 330,000 followers, over 75 million views</span>, and <span class="bio-variable" data-type="stats2">a complex psychological relationship with numbers</span>.
                </p>

                <p>
                    At the moment <span class="bio-variable" data-type="collaboration">he is creating campaigns with Serious People, a climate campaign studio he co-founded, and creating weekly videos for Greenpeace</span>.
                </p>
            </div>
        </div>

        <!-- Controls - now below bio -->
        <div class="flex gap-3 justify-center">
            <a 
                id="download-photo"
                href="/img/olifrost.jpg" 
                download="oli-frost-headshot.jpg"
                class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors text-sm"
            >
                Download Photo
            </a>
            <button 
                id="copy-bio" 
                class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors text-sm"
            >
                Copy Bio
            </button>
            <button 
                id="reset-bio" 
                class="px-6 py-2 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition-colors text-sm"
            >
                Reset
            </button>
        </div>
    </div>

    <!-- Options panel (appears when clicking variables) -->
    <div id="options-panel" class="hidden bg-white border border-gray-300 rounded-lg shadow-xl p-0 z-50 min-w-80">
        <div id="options-content" class="max-h-80 overflow-y-auto"></div>
    </div>
</div>

<script>
    // Bio options data
    const bioOptions: Record<string, string[]> = {
        intro: [
            "makes songs, films and websites about the climate crisis",
            "is a climate satirist and online creator",
            "is a musician, filmmaker and digital artist",
            "is a total nobody"
        ],
        achievement1: [
            "got Greta Thunberg dancing the macarena",
            "created a fossil fuel funfair",
            "made a video game about asset management",
            "sold all his personal data on eBay",
            "played the recorder for Simon Cowell",
            "took a shellphone to the UN Ocean Conference",
            "delivered a tiny violin to Shell executives",
            "played recorder on Britain's Got Talent",
            "created a viral song about socialist vampires",
            "made a wellness app for oil executives",
            "organised a climate strike for baby penguins in Antarctica",
            "created a series of viral climate strike posters",
            "was president of his university's bongo society (unverified)"
        ],
        achievement2: [
            "created a fossil fuel funfair",
            "made a video game about asset management",
            "sold all his personal data on eBay",
            "played the recorder for Simon Cowell",
            "got Greta Thunberg dancing the macarena",
            "took a shellphone to the UN Ocean Conference", 
            "delivered a tiny violin to Shell executives",
            "played recorder on Britain's Got Talent",
            "created a viral song about socialist vampires",
            "made a wellness app for oil executives",
            "organised a climate strike for baby penguins in Antarctica",
            "created a series of viral climate strike posters",
            "was president of his university's bongo society (unverified)"
        ],
        achievement3: [
            "made a video game about asset management",
            "sold all his personal data on eBay",
            "played the recorder for Simon Cowell",
            "got Greta Thunberg dancing the macarena",
            "created a fossil fuel funfair",
            "took a shellphone to the UN Ocean Conference",
            "delivered a tiny violin to Shell executives", 
            "played recorder on Britain's Got Talent",
            "created a viral song about socialist vampires",
            "made a wellness app for oil executives",
            "organised a climate strike for baby penguins in Antarctica",
            "created a series of viral climate strike posters",
            "was president of his university's bongo society (unverified)"
        ],
        outlet1: [
            "UK Parliament",
            "his mother's fridge",
            "The Financial Times",
            "Vice",
            "Fox News",
            "RT News",
            "Reddit",
            "TikTok",
            "BBC",
            "Channel 4",
            "Sky News"
        ],
        outlet2: [
            "Britain's Got Talent",
            "his mother's fridge",
            "The Financial Times",
            "Vice",
            "Fox News",
            "RT News",
            "Reddit",
            "TikTok",
            "BBC",
            "Channel 4",
            "Sky News"
        ],
        outlet3: [
            "BBC",
            "his mother's fridge",
            "The Financial Times",
            "Vice",
            "Fox News",
            "RT News",
            "Reddit",
            "TikTok",
            "Channel 4",
            "Sky News",
            "UK Parliament"
        ],
        outlet4: [
            "Fox News",
            "his mother's fridge",
            "The Financial Times",
            "Vice",
            "RT News",
            "Reddit",
            "TikTok",
            "BBC",
            "Channel 4",
            "Sky News",
            "UK Parliament"
        ],
        outlet5: [
            "music festivals",
            "his mother's fridge",
            "underground bunkers",
            "corporate boardrooms",
            "university lectures",
            "protest marches",
            "comedy clubs",
            "shopping centers"
        ],
        outlet6: [
            "art shows",
            "his mother's fridge",
            "underground bunkers",
            "corporate boardrooms",
            "university lectures",
            "protest marches",
            "comedy clubs",
            "shopping centers"
        ],
        outlet7: [
            "on bins",
            "his mother's fridge",
            "underground bunkers",
            "corporate boardrooms",
            "university lectures",
            "protest marches",
            "comedy clubs",
            "shopping centers"
        ],
        stats1: [
            "It's given him 330,000 followers, over 75 million views",
            "Only 1 person has recognized him in Franco Manca (but he was wearing a hat)",
            "This has resulted in 330k followers and over 75 million views",
            "He's been viewed more times than he's had hot dinners",
            "The numbers are frankly embarrassing"
        ],
        stats2: [
            "a complex psychological relationship with numbers",
            "an unhealthy obsession with metrics",
            "the ability to ruin any dinner party with climate facts",
            "a tendency to check his phone too much",
            "the strange urge to make everything about the climate crisis"
        ],
        collaboration: [
            "he is creating campaigns with Serious People, a climate campaign studio he co-founded, and creating weekly videos for Greenpeace",
            "he co-founded climate campaign studio Serious People and works with Greenpeace",
            "he works with Greenpeace making weekly videos and runs climate campaigns through Serious People",
            "he's trying to save the world one satirical video at a time",
            "he's making content that his mum describes as 'very nice, dear'"
        ]
    };

    // Carousel functionality
    let currentSlide = 0;
    const slides = document.querySelectorAll('#bio-builder #carousel-track img');
    const dots = document.querySelectorAll('#bio-builder .carousel-dot');
    const track = document.querySelector('#bio-builder #carousel-track') as HTMLElement;
    const downloadLink = document.querySelector('#bio-builder #download-photo') as HTMLAnchorElement;
    
    const photos = [
        { src: '/img/olifrost.jpg', filename: 'oli-frost-headshot.jpg' },
        { src: '/img/olifrost-full.jpg', filename: 'oli-frost-full.jpg' },
        { src: '/img/olifrost-carrot.jpg', filename: 'oli-frost-carrot.jpg' }
    ];

    function updateCarousel() {
        if (track) {
            track.style.transform = `translateX(-${currentSlide * 100}%)`;
        }
        
        // Update dots
        dots.forEach((dot, index) => {
            dot.classList.toggle('bg-blue-600', index === currentSlide);
            dot.classList.toggle('bg-gray-300', index !== currentSlide);
        });
        
        // Update download link with smooth transition
        if (downloadLink && photos[currentSlide]) {
            downloadLink.href = photos[currentSlide].src;
            downloadLink.download = photos[currentSlide].filename;
        }
    }

    dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
            currentSlide = index;
            updateCarousel();
        });
        
        // Add keyboard support for dots
        dot.addEventListener('keydown', (e) => {
            const keyEvent = e as KeyboardEvent;
            if (keyEvent.key === 'Enter' || keyEvent.key === ' ') {
                keyEvent.preventDefault();
                currentSlide = index;
                updateCarousel();
            }
        });
        
        // Make dots keyboard accessible
        dot.setAttribute('tabindex', '0');
        dot.setAttribute('role', 'button');
        dot.setAttribute('aria-label', `Photo ${index + 1}`);
    });

    // Bio variable click handling
    let currentOptionsPanel: HTMLElement | null = null;

    function showOptions(type: string, element: HTMLElement) {
        const panel = document.querySelector('#bio-builder #options-panel') as HTMLElement;
        const content = document.querySelector('#bio-builder #options-content') as HTMLElement;
        
        if (!panel || !content) return;
        
        currentOptionsPanel = element;
        
        // Clear and populate content
        content.innerHTML = '';
        
        bioOptions[type]?.forEach((option: string, index: number) => {
            const button = document.createElement('button');
            button.textContent = option;
            button.className = `block w-full text-left p-4 hover:bg-blue-50 transition-colors text-sm border-b border-gray-100 last:border-b-0 ${index === 0 ? 'rounded-t-lg' : ''} ${index === bioOptions[type].length - 1 ? 'rounded-b-lg' : ''}`;
            button.addEventListener('click', () => {
                if (currentOptionsPanel) {
                    currentOptionsPanel.textContent = option;
                }
                panel.classList.add('hidden');
            });
            content.appendChild(button);
        });
        
        // Position panel near the clicked element
        panel.classList.remove('hidden');
        panel.style.position = 'fixed';
        panel.style.zIndex = '1000';
        
        // Position below and to the right of the clicked element
        const rect = element.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const panelWidth = 320; // min-w-80
        const panelHeight = 320; // estimated max height
        
        // Calculate position
        let left = rect.left;
        let top = rect.bottom + 8;
        
        // Adjust if panel would go off screen
        if (left + panelWidth > viewportWidth - 20) {
            left = viewportWidth - panelWidth - 20;
        }
        if (top + panelHeight > viewportHeight - 20) {
            top = rect.top - panelHeight - 8;
        }
        
        panel.style.left = `${Math.max(20, left)}px`;
        panel.style.top = `${Math.max(20, top)}px`;
    }

    // Add click handlers to bio variables (scoped to bio-builder)
    document.querySelectorAll('#bio-builder .bio-variable').forEach(variable => {
        variable.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;
            if (target) {
                const type = target.getAttribute('data-type');
                if (type) {
                    showOptions(type, target);
                }
            }
        });
    });

    // Hide options panel when clicking outside (scoped to bio-builder)
    document.addEventListener('click', (e) => {
        const panel = document.querySelector('#bio-builder #options-panel') as HTMLElement;
        const target = e.target as Element;
        if (panel && 
            !target.closest('#bio-builder .bio-variable') && 
            !target.closest('#bio-builder #options-panel')) {
            panel.classList.add('hidden');
        }
    });

    // Copy bio functionality
    document.querySelector('#bio-builder #copy-bio')?.addEventListener('click', async () => {
        const bioOutput = document.querySelector('#bio-builder #bio-output') as HTMLElement;
        const button = document.querySelector('#bio-builder #copy-bio') as HTMLButtonElement;
        
        if (!bioOutput || !button) return;
        
        const bioText = bioOutput.textContent?.trim() || '';
        const originalText = button.textContent;
        const originalClass = button.className;
        
        try {
            // Try to use the clipboard API
            await navigator.clipboard.writeText(bioText);
            
            button.textContent = 'Copied!';
            button.className = 'px-6 py-2 bg-green-50 border border-green-300 text-green-700 rounded transition-colors text-sm';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.className = originalClass;
            }, 2000);
            
        } catch (err) {
            // Fallback for browsers that don't support clipboard API
            try {
                // Create a temporary textarea to select the text
                const textArea = document.createElement('textarea');
                textArea.value = bioText;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    button.textContent = 'Copied!';
                    button.className = 'px-6 py-2 bg-green-50 border border-green-300 text-green-700 rounded transition-colors text-sm';
                } else {
                    button.textContent = 'Copy failed - select text manually';
                    button.className = 'px-6 py-2 bg-red-50 border border-red-300 text-red-700 rounded transition-colors text-sm';
                }
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.className = originalClass;
                }, 3000);
                
            } catch (fallbackErr) {
                button.textContent = 'Select text to copy manually';
                button.className = 'px-6 py-2 bg-blue-50 border border-blue-300 text-blue-700 rounded transition-colors text-sm';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.className = originalClass;
                }, 3000);
            }
        }
    });

    // Reset functionality
    document.querySelector('#bio-builder #reset-bio')?.addEventListener('click', () => {
        // Reset to default values
        const defaults: Record<string, string> = {
            intro: "makes songs, films and websites about the climate crisis",
            achievement1: "got Greta Thunberg dancing the macarena",
            achievement2: "created a fossil fuel funfair",
            achievement3: "made a video game about asset management",
            outlet1: "UK Parliament",
            outlet2: "Britain's Got Talent",
            outlet3: "BBC",
            outlet4: "Fox News",
            outlet5: "music festivals",
            outlet6: "art shows",
            outlet7: "on bins",
            stats1: "It's given him 330,000 followers, over 75 million views",
            stats2: "a complex psychological relationship with numbers",
            collaboration: "he is creating campaigns with Serious People, a climate campaign studio he co-founded, and creating weekly videos for Greenpeace"
        };
        
        Object.entries(defaults).forEach(([type, text]) => {
            const element = document.querySelector(`#bio-builder [data-type="${type}"]`) as HTMLElement;
            if (element) {
                element.textContent = text;
            }
        });
        
        // Hide options panel
        document.querySelector('#bio-builder #options-panel')?.classList.add('hidden');
    });
</script>

<style>
    /* Shortcuts-style variable styling */
    #bio-builder .bio-variable {
        background-color: rgb(219 234 254); /* bg-blue-100 */
        color: rgb(37 99 235); /* text-blue-600 */
        padding: 2px 6px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 500;
        border: 1px solid rgb(191 219 254); /* border-blue-200 */
    }
    
    #bio-builder .bio-variable:hover {
        background-color: rgb(191 219 254); /* bg-blue-200 */
        color: rgb(29 78 216); /* text-blue-700 */
        border-color: rgb(147 197 253); /* border-blue-300 */
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #bio-builder .prose p {
        margin-bottom: 0;
    }
    
    #bio-builder #options-panel {
        position: relative;
    }
    
    /* Carousel dot styling */
    #bio-builder .carousel-dot {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #bio-builder .carousel-dot:hover {
        transform: scale(1.2);
    }
    
    #bio-builder .carousel-dot.bg-blue-600:hover {
        background-color: rgb(29 78 216); /* bg-blue-700 */
    }
    
    #bio-builder .carousel-dot.bg-gray-300:hover {
        background-color: rgb(156 163 175); /* bg-gray-400 */
    }
</style>
