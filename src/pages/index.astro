---
import Layout from '../layouts/Layout.astro';
import ProjectSection from '../components/ProjectSection.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../consts';
import { getCollection } from 'astro:content';
import { getBlogUrl } from '../utils/urls';

// Get all projects
const allProjects = await getCollection('blog');

// Filter projects by category (manual selection by frontmatter)
const songProjects = allProjects
  .filter(project => project.data.homepageCategory === 'songs')
  .sort((a, b) => (a.data.homepageOrder || 0) - (b.data.homepageOrder || 0))
  .slice(0, 3);

const featuredProjects = allProjects
  .filter(project => project.data.homepageCategory === 'climate')
  .sort((a, b) => (a.data.homepageOrder || 0) - (b.data.homepageOrder || 0))
  .slice(0, 3);

const archiveProjects = allProjects
  .filter(project => project.data.homepageCategory === 'archive')
  .sort((a, b) => (a.data.homepageOrder || 0) - (b.data.homepageOrder || 0))
  .slice(0, 3);

// Fallback to show the most recent projects if no manual selection is available
const recentProjects = allProjects
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const displaySongs = songProjects.length > 0 ? songProjects : recentProjects.filter(p => p.data.tags?.includes('music')).slice(0, 3);
const displayFeatured = featuredProjects.length > 0 ? featuredProjects : recentProjects.slice(0, 3);
const displayArchive = archiveProjects.length > 0 ? archiveProjects : recentProjects.slice(3, 6);
const recentThreeProjects = recentProjects.slice(0, 3);
---

<Layout title={SITE_TITLE} description={SITE_DESCRIPTION}>
    <section class="prose prose-base prose-p:first:mt-0 prose-a:font-light prose-a:text-blue-600 prose-a:hover:text-blue-400 mb-6 max-w-none">
        <div class="text-2xl max-w-6xl mb-6 space-y-6 transition-all">
            <p>
                I'm Oli Frost, I make songs, films and websites about the climate crisis. I also 
                <span 
                    x-data="{
                        achievements: [
                            { text: 'got Greta Thunberg dancing the macarena', link: '/blog/the-greta-thunberg-song' },
                            { text: 'created a fossil fuel funfair', link: '/blog/fossil-fuel-funfair' },
                            { text: 'made a video game about asset management', link: '/blog/asset-management-game' },
                            { text: 'sold all his personal data on eBay', link: '/blog/personal-data-ebay' },
                            { text: 'played the recorder for Simon Cowell', link: '/blog/recorder-simon-cowell' },
                            { text: 'took a shellphone to the UN Ocean Conference', link: '/blog/shellphone-un' },
                            { text: 'delivered a tiny violin to Shell executives', link: '/blog/tiny-violin-shell' },
                            { text: 'played recorder on Britain' + String.fromCharCode(39) + 's Got Talent', link: '/blog/britains-got-talent' },
                            { text: 'created a viral song about socialist vampires', link: '/blog/socialist-vampires' },
                            { text: 'made a wellness app for oil executives', link: '/blog/wellness-app-oil' },
                            { text: 'organised a climate strike for baby penguins in Antarctica', link: '/blog/antarctica-climate-strike' },
                            { text: 'created a series of viral climate strike posters', link: '/blog/climate-strike-posters' },
                            { text: 'was president of his university' + String.fromCharCode(39) + 's bongo society (unverified)', link: '/about' }
                        ],
                        currentIndex: 0,
                        visible: true
                    }"
                    x-init="setInterval(() => { visible = false; setTimeout(() => { currentIndex = (currentIndex + 1) % achievements.length; visible = true; }, 300); }, 3000);"
                    class="relative inline-block min-h-[1.5rem]"
                >
                    <a 
                        :href="achievements[currentIndex].link" 
                        class="text-blue-600 hover:text-blue-400 transition-all duration-300"
                        :class="{ 'opacity-0 translate-y-2': !visible, 'opacity-100 translate-y-0': visible }"
                        x-text="achievements[currentIndex].text"
                    ></a>
                </span>.
                <a href="/about" class="text-blue-600 hover:text-blue-400 text-xl ml-2">More…</a>
            </p>
        </div>
    </section>
    
    <ProjectSection 
        title="Music" 
        viewAllLink="/tags/music" 
        projects={displaySongs}
        showTags={false}
    />
    
    <ProjectSection 
        title="Projects" 
        viewAllLink="/tags/climate" 
        projects={displayFeatured}
        showTags={false}
    />
    
    <ProjectSection 
        title="From the archive" 
        viewAllLink="/tags/other" 
        projects={displayArchive}
        showTags={false}
    />
    
    <div class="flex justify-center mt-6">
        <a href="/blog" class="text-blue-600 hover:text-blue-800 text-lg font-medium transition-colors">
            View all projects →
        </a>
    </div>
</Layout>
